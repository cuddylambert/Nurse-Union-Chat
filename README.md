# UnionExplain

UnionExplain is a retrieval-augmented question answering platform for union collective bargaining agreements. Phase one focuses on the University of California Registered Nurses (NX unit, represented by CNA) and surfaces plain-English answers with direct citations back to the contract PDFs.

## Monorepo layout

- `backend/` — Fastify + TypeScript API that handles retrieval, OpenAI orchestration, and admin tooling.
- `frontend/` — Next.js (App Router) interface styled with Tailwind and shadcn-inspired components.
- `ingest/` — Scripts that download, hash, and prepare contract source documents for indexing.
- `data/` — Storage for raw and processed contract files (kept locally, not committed).

## Getting started

1. Install dependencies (requires [pnpm](https://pnpm.io/)):

   ```bash
   pnpm install
   ```

2. Copy the environment template and fill in credentials:

   ```bash
   cp .env.sample .env
   ```

   - `OPENAI_API_KEY` is required for GPT-4o-mini answers and embeddings.
   - `DATABASE_URL` should point to a Postgres instance with the `pgvector` extension enabled.
   - `NEXT_PUBLIC_API_BASE_URL` must reference the backend URL (defaults to `http://localhost:4000`).

3. Run the ingest pipeline for the NX contract (downloads PDFs and records hashes):

   ```bash
   pnpm ingest:nx
   ```

4. Start the development stack in parallel:

   ```bash
   pnpm dev
   ```

   - Backend runs on `http://localhost:4000`.
   - Frontend runs on `http://localhost:3000` and proxies API calls using `NEXT_PUBLIC_API_BASE_URL`.

## Backend API

| Method | Path | Description |
| ------ | ---- | ----------- |
| `POST` | `/api/ask` | Answer a contract question (returns HTML, citations, assumptions, and confidence). |
| `POST` | `/api/admin/reindex?union=NX` | Trigger a background reindex for the NX corpus. |
| `GET` | `/api/sources?union=NX` | List available source documents, hashes, and schema version. |
| `GET` | `/healthz` | Basic health probe. |

Responses follow the shape:

```json
{
  "answerHtml": "<section>...</section>",
  "evidence": [
    {
      "article": "6.C.2",
      "quote": "…",
      "link": "https://...#page=1"
    }
  ],
  "assumptions": ["None"],
  "confidence": "high"
}
```

The backend coordinates hybrid retrieval (BM25 + vector) against the `contract_chunks` table. When OpenAI credentials are unavailable it falls back to returning the top chunks with a low-confidence notice.

## Frontend UX

The Next.js client mirrors a modern RAG assistant with:

- Example prompts and a prominent disclaimer.
- Local history (persisted in `localStorage`) with room for Clerk/Auth.js integration.
- Plain-language answers capped at 120 words, formatted with citations, assumptions, and the global disclaimer.
- Accessible, mobile-friendly styling using Tailwind.

## Ingestion pipeline

`ingest/nx_crawl.js` downloads the contract PDF, appendices, side letters, and MOUs directly from UCnet. Each file is hashed (SHA-256) and recorded in `data/raw/nx/manifest.json`. The script falls back to existing local files if the site is unreachable.

## Scripts

| Command | Description |
| ------- | ----------- |
| `pnpm dev` | Run backend and frontend development servers together. |
| `pnpm build` | Build all workspaces. |
| `pnpm lint` | Run linting for each workspace (if configured). |
| `pnpm typecheck` | Run TypeScript checks across workspaces. |
| `pnpm ingest:nx` | Download and log the latest NX contract PDFs. |

## Testing roadmap

- Golden answer regression tests (preceptor differential, grievance timelines, overtime scenarios).
- Link validation to ensure every citation opens the correct PDF page.
- Metadata drift guardrails to detect changes after weekly re-crawls.

## Disclaimer

All responses generated by UnionExplain are informational only and do **not** constitute legal advice. Always consult your union representative or legal counsel for official guidance.
